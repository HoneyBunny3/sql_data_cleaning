/*=============================================================================================
   PL/SQL Script: export_cleaned_data.sql
===============================================================================================

   üí° Purpose:
   --------------------------------------------------------------------------------------------
   This script exports cleaned data from the `contracts` table to a CSV file located in the 
   'data/cleaned' directory of the repository. The export includes:
   ‚ûú A header row with column names for better readability.
   ‚ûú All cleaned data rows from the `contracts` table.

   ‚ú® Features:
   --------------------------------------------------------------------------------------------
   ‚ûú Exports data in a CSV format with a structured header row.
   ‚ûú Logs progress, file path, and potential errors using `DBMS_OUTPUT.PUT_LINE`.
   ‚ûú Ensures exported data is up-to-date and consistent with the latest cleaning operations.

   üõ†Ô∏è Execution Instructions:
   --------------------------------------------------------------------------------------------
   1Ô∏è‚É£ Save this script as `export_cleaned_data.sql`.
   2Ô∏è‚É£ Open Oracle SQL Developer (or another PL/SQL-compatible environment).
   3Ô∏è‚É£ Ensure the directory `data/cleaned` exists and has write permissions.
   4Ô∏è‚É£ Grant the Oracle database access to the directory:
       
       CREATE OR REPLACE DIRECTORY cleaned_data_dir AS '/path/to/data/cleaned';
       GRANT WRITE, READ ON DIRECTORY cleaned_data_dir TO <USER>;
       
   5Ô∏è‚É£ Execute the script.
   6Ô∏è‚É£ Verify the CSV file is created and contains the expected data.

   üöÄ Optional Enhancements:
   --------------------------------------------------------------------------------------------
   ‚û§ Include Filters During Export:
       -- Export only specific rows that meet certain criteria:
       
       SELECT * FROM contracts WHERE contract_status = 'ACTIVE';

   ‚û§ Add File Metadata Logging:
       -- Create a log entry for each export operation:
       
       CREATE TABLE export_log (
           export_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
           file_name VARCHAR2(255),
           export_date TIMESTAMP DEFAULT SYSDATE,
           record_count NUMBER
       );
       INSERT INTO export_log (file_name, record_count)
       VALUES ('cleaned_data.csv', (SELECT COUNT(*) FROM contracts));

   ‚û§ Automate Scheduled Exports:
       -- Use `DBMS_SCHEDULER` to automate exports at regular intervals:
       
       BEGIN
           DBMS_SCHEDULER.CREATE_JOB (
               job_name        => 'data_export_job',
               job_type        => 'PLSQL_BLOCK',
               job_action      => 'BEGIN EXECUTE IMMEDIATE ''@export_cleaned_data.sql''; END;',
               start_date      => SYSTIMESTAMP,
               repeat_interval => 'FREQ=DAILY; BYHOUR=1',
               enabled         => TRUE
           );
       END;

   ‚ö†Ô∏è Prerequisites:
   --------------------------------------------------------------------------------------------
   ‚öô Ensure the `contracts` table contains cleaned data.
   ‚öô Verify the `cleaned_data_dir` directory exists with the correct permissions.
   ‚öô Grant appropriate privileges to the database user for file operations.

=============================================================================================*/

/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
üü¢ BEGINNING OF SCRIPT üü¢
-----------------------------------------------------------------------------------------------
Export the cleaned `contracts` data to a CSV file for easy sharing and reporting. Ensure all 
prerequisites are met, and execute with confidence. Monitor the logs for progress and results!
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/

SELECT 'ROW_KEY,CONTRACT_SYNOPSIS,CONTRACT_CONTACT_NM,CONTRACT_CONTACT_VOICE_PH_NO,CONTRACT_CONTACT_EMAIL_AD,MA_PRCH_LMT_AM,MA_ITD_ORD_AM,EFBGN_DT,EFEND_DT'
INTO OUTFILE 'data/cleaned/exported_cleaned_data.csv'
FIELDS TERMINATED BY ',' ENCLOSED BY '"'
LINES TERMINATED BY '\n';

/*
Append the cleaned data to the file. Dates are formatted as YYYY-MM-DD for consistency.
*/
SELECT ROW_KEY, 
       CONTRACT_SYNOPSIS, 
       CONTRACT_CONTACT_NM, 
       CONTRACT_CONTACT_VOICE_PH_NO, 
       CONTRACT_CONTACT_EMAIL_AD, 
       MA_PRCH_LMT_AM, 
       MA_ITD_ORD_AM, 
       DATE_FORMAT(EFBGN_DT, '%Y-%m-%d') AS EFBGN_DT, 
       DATE_FORMAT(EFEND_DT, '%Y-%m-%d') AS EFEND_DT
INTO OUTFILE 'data/cleaned/exported_cleaned_data.csv'
FIELDS TERMINATED BY ',' ENCLOSED BY '"'
LINES TERMINATED BY '\n'
FROM contracts;